var framboise=null;function Framboise(){}
Framboise.prototype.start=function(){var a=this.mapLocationParameters(location.search),c,d,b=null,e=new Engine;c=this.parseParm("fuzzer",a,this.parseFuzzers);if(0==c.length)return-1;if(d=this.parseParm("max-commands",a,parseInt))e.prefs.maxCommands=Random.range(Math.round(d/2)/2,d);(d=this.parseParm("seed",a,parseFloat))&&(b=d);if(d=this.parseParm("timeout",a,parseInt))e.prefs.reloadTimeout=d;e.prefs.commands.settimeout=this.parseParm("with-set-timeout",a,this.parseBoolean);e.prefs.commands.setinterval=
this.parseParm("with-set-interval",a,this.parseBoolean);e.prefs.commands.events=this.parseParm("with-events",a,this.parseBoolean);window.debug=this.parseParm("debug",a,this.parseBoolean);(d=this.parseParm("ws-logger",a,parseInt))?(websocket=new WebSocket("ws://localhost:"+d+"/"),websocket.onopen=function(a){e.initialize(b);e.run(c)}):(e.initialize(b),e.run(c));return 0};Framboise.prototype.isParameter=function(a,c){return c.hasOwnProperty(a)&&void 0!==c[a]&&c[a]};
Framboise.prototype.parseParm=function(a,c,d){return this.isParameter(a,c)?d.call(this,c[a]):null};Framboise.prototype.mapLocationParameters=function(a){var c={},d,b;a=a.substring(1).split("&");for(d=0;d<a.length;d++)b=a[d].split("="),c[decodeURIComponent(b[0])]=decodeURIComponent(b[1]);return c};Framboise.prototype.parseProbabilityList=function(a){var c=[];a.split(",").forEach(function(a){a=a.split(":");var b=parseInt(a[0]);c.push([b,a[1]])});return c};
Framboise.prototype.parseFuzzers=function(a){a=this.parseProbabilityList(a);var c,d;for(c=0;c<a.length;c++){d="fuzzer"+a[c][1];try{this.loadPlugin(d,"modules/"+a[c][1]+"/fuzzer.js")}catch(b){}d in window?(Logger.dumpln("Fuzzer: "+d+" (loaded)"),a[c][1]=window[d],"dependsOnModules"in a[c][1]&&this.loadPluginDependencies(a[c][1])):(Logger.error("Fuzzer: "+d+" (failed)"),a.splice(c,1),--c)}return a};Framboise.prototype.parseBoolean=function(a){return(a=""+a)?"true"==a.toLowerCase():!1};
Framboise.prototype.loadPlugin=function(a,c){function d(){if(4==b.readyState)if(200==b.status||0==b.status){if(b.responseText||!document.getElementById(a)){var c=document.getElementsByTagName("HEAD").item(0),d=document.createElement("script");d.type="text/javascript";d.id=a;d.text=b.responseText;c.appendChild(d)}}else Logger.error("XHR error: "+b.statusText+" ("+b.status+")")}var b;b="file:"==window.location.protocol&&"ActiveXObject"in window?new window.ActiveXObject("Microsoft.XMLHTTP"):new window.XMLHttpRequest;
null!=b?(b.open("GET",c,!1),b.onreadystatechange=d,b.send(null)):Logger.error("XMLHttpRequest() not supported.")};Framboise.prototype.loadPluginDependencies=function(a){var c,d=a.dependsOnModules,b;for(c=0;c<d.length;c++)if(b="fuzzer"+a.dependsOnModules[c],!(b in window)){try{this.loadPlugin(b,"modules/"+a.dependsOnModules[c]+"/fuzzer.js")}catch(e){}b in window?Logger.dumpln("+ dependency: "+b+" (loaded)"):Logger.error("+ dependency: "+b+" (failed)")}};
function Engine(){this.prefs={reloadTimeout:0,maxCommands:30,commands:{trycatch:!0,settimeout:!0,setinterval:!0,forcegc:!1,events:!0}}}Engine.prototype.initialize=function(a){Random.init(a);o=new Objects;Logger.separator();Logger.testcase(Logger.comment("Date: "+new Date));Logger.testcase(Logger.comment("Seed: "+Random.seed));window.debug&&Logger.testcase("Logger={}; Logger.JSError=function(e){};")};
Engine.prototype.onInit=function(a){var c,d,b,e;for(c=0;c<a.length;c++)if(b=a[c][1].onInit(),b="string"==typeof b?[b]:b,Array.isArray(b))for(d=0;d<b.length;d++)e=b[d],0<e.length&&this.fuzz(e)};Engine.prototype.makeSubCommands=function(a){var c=[],d=Random.range(1,6),b,e,f,g;for(b=0;b<d;b++)if(e=Random.choose(a),f=e.makeCommand(),f="string"==typeof f?[f]:f,Array.isArray(f))for(e=0;e<f.length;e++)g=f[e],0<g.length&&c.push(g);return c.join("\n")};
Engine.prototype.makeCommands=function(a){var c,d,b,e,f;for(c=0;c<this.prefs.maxCommands;c++)if(e=Random.choose(a),f=e.makeCommand(),f="string"==typeof f?[f]:f,Array.isArray(f))for(d=0;d<f.length;d++)if(cmd=f[d],0!=cmd.length)switch(Random.number(16)){case 0:this.prefs.commands.setinterval&&(b=100*Math.random(),this.fuzz("setInterval("+Function(JS.safely(cmd))+", "+b+")"));break;case 1:this.prefs.commands.settimeout&&(b=1E3*Math.random(),this.prefs.reloadTimeout+=b,this.fuzz("setTimeout("+Function(JS.safely(cmd))+
", "+b+")"));break;case 2:if(this.prefs.commands.events&&"Events"in e&&(b=Random.pick(Utils.getKeysFromHash(e.Events)),o.has(b))){var g=Random.pick(e.Events[b]),h="function(e) { "+this.makeSubCommands(a)+"}",g=[Utils.quote(g),h];this.fuzz(o.pick(b)+".addEventListener"+JS.methodHead(g))}break;default:this.fuzz(cmd)}};Engine.prototype.fuzz=function(a){this.prefs.commands.trycatch&&(a=JS.safely(a));Logger.testcase(a);eval(a)};
Engine.prototype.onFinish=function(a){var c,d,b;for(c=0;c<a.length;c++)if(b=a[c][1].onFinish(),b="string"==typeof b?[b]:b,Array.isArray(b))for(d=0;d<b.length;d++)0<b[d].length&&this.fuzz(b[d])};Engine.prototype.run=function(a){this.onInit(a);this.makeCommands(a);this.onFinish(a);this.fuzz('setTimeout("window.location.reload()", '+this.prefs.reloadTimeout+")");Logger.dumpln(Logger.comment("### END OF TESTCASE"))};
document.addEventListener("DOMContentLoaded",function(){framboise=new Framboise;framboise.start()},!1);
